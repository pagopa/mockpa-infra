{
    "name": "df_clean_up_wfesp",
    "properties": {
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "dataset": {
                        "referenceName": "wfespRpt",
                        "type": "DatasetReference"
                    },
                    "name": "wfespRpt"
                },
                {
                    "dataset": {
                        "referenceName": "wfespCarrelloRpt",
                        "type": "DatasetReference"
                    },
                    "name": "wfespCarrelloRpt",
                    "description": "Extract carrello rpt where inserted_timestamp is in the day"
                },
                {
                    "dataset": {
                        "referenceName": "wfespRedirectMyBank",
                        "type": "DatasetReference"
                    },
                    "name": "wfespRedirectMyBank",
                    "description": "Extract redirect_my_bank where inserted_timestamp is in the day"
                }
            ],
            "sinks": [
                {
                    "dataset": {
                        "referenceName": "wfespRpt",
                        "type": "DatasetReference"
                    },
                    "name": "sinkRptDeleteDB",
                    "description": "Delete data of wfespRpt"
                },
                {
                    "dataset": {
                        "referenceName": "wfespCarrelloRpt",
                        "type": "DatasetReference"
                    },
                    "name": "sinkCarrelloRptDeleteDB",
                    "description": "Delete data of wfespCarrelloRpt"
                },
                {
                    "dataset": {
                        "referenceName": "wfespRedirectMyBank",
                        "type": "DatasetReference"
                    },
                    "name": "sinkRedirectMyBankDeleteDB",
                    "description": "Delete data of wfespRedirectMyBank"
                }
            ],
            "transformations": [
                {
                    "name": "checkRecordToDeleteRpt",
                    "description": "deleting record if inserted_timestamp < now - 'n days' "
                },
                {
                    "name": "checkRecordToDeleteCarrelloRpt",
                    "description": "deleting record if inserted_timestamp < now - 'n days' "
                },
                {
                    "name": "checkRecordToDeleteRedirectMyBank",
                    "description": "deleting record if inserted_timestamp < now - 'n days' "
                }
            ],
            "scriptLines": [
                "parameters{",
                "     daysToKeep as integer (90)",
                "}",
                "source(output(",
                "          obj_id as decimal(38,18),",
                "          id_dominio as string,",
                "          iuv as string,",
                "          ccp as string,",
                "          codice_carrello as string,",
                "          staz_intermediariopa as string,",
                "          intermediariopa as string,",
                "          canale as string,",
                "          intermediariopsp as string,",
                "          psp as string,",
                "          id_sessione as string,",
                "          parametri_pagamento_immediato as string,",
                "          parametri_profilo_pagamento as string,",
                "          url_redirezione_pa as string,",
                "          url_redirezione_psp as string,",
                "          stato as string,",
                "          return_code as string,",
                "          esito_redirect as string,",
                "          tipo_interazione as string,",
                "          mobile_token as string,",
                "          rrn as string,",
                "          esito_transazione_carta as string,",
                "          codice_autorizzativo as string,",
                "          parametri_pm as string,",
                "          timestamp_operazione as timestamp,",
                "          importo_totale_pagato as decimal(19,0),",
                "          inserted_timestamp as timestamp,",
                "          inserted_by as string,",
                "          updated_timestamp as timestamp,",
                "          updated_by as string",
                "     ),",
                "     allowSchemaDrift: false,",
                "     validateSchema: false,",
                "     isolationLevel: 'READ_UNCOMMITTED',",
                "     query: (\"SELECT * FROM wfesp.rpt WHERE inserted_timestamp < (NOW()::date - '{$daysToKeep} DAY'::interval)\"),",
                "     format: 'query') ~> wfespRpt",
                "source(output(",
                "          obj_id as long,",
                "          id_carrello as string,",
                "          codice_carrello as string,",
                "          staz_intermediariopa as string,",
                "          intermediariopa as string,",
                "          canale as string,",
                "          intermediariopsp as string,",
                "          psp as string,",
                "          id_sessione as string,",
                "          parametri_pagamento_immediato as string,",
                "          parametri_profilo_pagamento as string,",
                "          url_redirezione_pa as string,",
                "          url_redirezione_psp as string,",
                "          stato as string,",
                "          return_code as string,",
                "          esito_redirect as string,",
                "          tipo_interazione as string,",
                "          mobile_token as string,",
                "          rrn as string,",
                "          esito_transazione_carta as string,",
                "          codice_autorizzativo as string,",
                "          parametri_pm as string,",
                "          timestamp_operazione as timestamp,",
                "          importo_totale_pagato as decimal(19,0),",
                "          inserted_timestamp as timestamp,",
                "          inserted_by as string,",
                "          updated_timestamp as timestamp,",
                "          updated_by as string",
                "     ),",
                "     allowSchemaDrift: false,",
                "     validateSchema: false,",
                "     isolationLevel: 'READ_UNCOMMITTED',",
                "     query: (\"SELECT * FROM wfesp.carrello_rpt WHERE inserted_timestamp < (NOW()::date - '{$daysToKeep} DAY'::interval)\"),",
                "     format: 'query') ~> wfespCarrelloRpt",
                "source(output(",
                "          obj_id as long,",
                "          id_dominio as string,",
                "          iuv as string,",
                "          ccp as string,",
                "          numero_ordine as string,",
                "          descr_ordine as string,",
                "          codice_mybank as string,",
                "          id_negozio as string,",
                "          importo as decimal(10,0),",
                "          chiave_avvio as string,",
                "          chiave_esito as string,",
                "          mac_richiesta as string,",
                "          mac_esito as string,",
                "          esito_ms as string,",
                "          aut as string,",
                "          bpw_tipo_transazione as string,",
                "          id_trans as string,",
                "          stato_sitord as string,",
                "          esito_sitord as string,",
                "          reqrefnum as string,",
                "          stato_pagamento as string,",
                "          url_situazione_ordine as string,",
                "          redirect_rpt as long,",
                "          redirect_carrello as long,",
                "          timestamp_esito as timestamp,",
                "          inserted_timestamp as timestamp,",
                "          inserted_by as string,",
                "          updated_timestamp as timestamp,",
                "          updated_by as string",
                "     ),",
                "     allowSchemaDrift: false,",
                "     validateSchema: false,",
                "     isolationLevel: 'READ_UNCOMMITTED',",
                "     query: (\"SELECT * FROM wfesp.redirect_my_bank WHERE inserted_timestamp < (NOW()::date - '{$daysToKeep} DAY'::interval)\"),",
                "     format: 'query') ~> wfespRedirectMyBank",
                "wfespRpt alterRow(deleteIf(toDate(toString(inserted_timestamp,'dd-MM-yyyy','it-IT'),'dd-MM-yyyy','it-IT')<currentDate())) ~> checkRecordToDeleteRpt",
                "wfespCarrelloRpt alterRow(deleteIf(toDate(toString(inserted_timestamp,'dd-MM-yyyy','it-IT'),'dd-MM-yyyy','it-IT')<currentDate())) ~> checkRecordToDeleteCarrelloRpt",
                "wfespRedirectMyBank alterRow(deleteIf(toDate(toString(inserted_timestamp,'dd-MM-yyyy','it-IT'),'dd-MM-yyyy','it-IT')<currentDate())) ~> checkRecordToDeleteRedirectMyBank",
                "checkRecordToDeleteRpt sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          obj_id as decimal(0,0),",
                "          id_dominio as string,",
                "          iuv as string,",
                "          ccp as string,",
                "          codice_carrello as string,",
                "          staz_intermediariopa as string,",
                "          intermediariopa as string,",
                "          canale as string,",
                "          intermediariopsp as string,",
                "          psp as string,",
                "          id_sessione as string,",
                "          parametri_pagamento_immediato as string,",
                "          parametri_profilo_pagamento as string,",
                "          url_redirezione_pa as string,",
                "          url_redirezione_psp as string,",
                "          stato as string,",
                "          return_code as string,",
                "          esito_redirect as string,",
                "          tipo_interazione as string,",
                "          mobile_token as string,",
                "          rrn as string,",
                "          esito_transazione_carta as string,",
                "          codice_autorizzativo as string,",
                "          parametri_pm as string,",
                "          timestamp_operazione as timestamp,",
                "          importo_totale_pagato as decimal(19,0),",
                "          inserted_timestamp as timestamp,",
                "          inserted_by as string,",
                "          updated_timestamp as timestamp,",
                "          updated_by as string",
                "     ),",
                "     deletable:true,",
                "     insertable:false,",
                "     updateable:false,",
                "     upsertable:false,",
                "     keys:['obj_id'],",
                "     format: 'table',",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     saveOrder: 1) ~> sinkRptDeleteDB",
                "checkRecordToDeleteCarrelloRpt sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          obj_id as decimal(0,0),",
                "          id_carrello as string,",
                "          codice_carrello as string,",
                "          staz_intermediariopa as string,",
                "          intermediariopa as string,",
                "          canale as string,",
                "          intermediariopsp as string,",
                "          psp as string,",
                "          id_sessione as string,",
                "          parametri_pagamento_immediato as string,",
                "          parametri_profilo_pagamento as string,",
                "          url_redirezione_pa as string,",
                "          url_redirezione_psp as string,",
                "          stato as string,",
                "          return_code as string,",
                "          esito_redirect as string,",
                "          tipo_interazione as string,",
                "          mobile_token as string,",
                "          rrn as string,",
                "          esito_transazione_carta as string,",
                "          codice_autorizzativo as string,",
                "          parametri_pm as string,",
                "          timestamp_operazione as timestamp,",
                "          importo_totale_pagato as decimal(19,0),",
                "          inserted_timestamp as timestamp,",
                "          inserted_by as string,",
                "          updated_timestamp as timestamp,",
                "          updated_by as string",
                "     ),",
                "     deletable:true,",
                "     insertable:false,",
                "     updateable:false,",
                "     upsertable:false,",
                "     keys:['obj_id'],",
                "     format: 'table',",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     saveOrder: 2) ~> sinkCarrelloRptDeleteDB",
                "checkRecordToDeleteRedirectMyBank sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          obj_id as decimal(0,0),",
                "          id_dominio as string,",
                "          iuv as string,",
                "          ccp as string,",
                "          numero_ordine as string,",
                "          descr_ordine as string,",
                "          codice_mybank as string,",
                "          id_negozio as string,",
                "          importo as decimal(10,0),",
                "          chiave_avvio as string,",
                "          chiave_esito as string,",
                "          mac_richiesta as string,",
                "          mac_esito as string,",
                "          esito_ms as string,",
                "          aut as string,",
                "          bpw_tipo_transazione as string,",
                "          id_trans as string,",
                "          stato_sitord as string,",
                "          esito_sitord as string,",
                "          reqrefnum as string,",
                "          stato_pagamento as string,",
                "          url_situazione_ordine as string,",
                "          redirect_rpt as decimal(0,0),",
                "          redirect_carrello as decimal(0,0),",
                "          timestamp_esito as timestamp,",
                "          inserted_timestamp as timestamp,",
                "          inserted_by as string,",
                "          updated_timestamp as timestamp,",
                "          updated_by as string",
                "     ),",
                "     deletable:true,",
                "     insertable:false,",
                "     updateable:false,",
                "     upsertable:false,",
                "     keys:['obj_id'],",
                "     format: 'table',",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     saveOrder: 3) ~> sinkRedirectMyBankDeleteDB"
            ]
        }
    }
}
