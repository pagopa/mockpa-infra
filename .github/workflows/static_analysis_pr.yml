name: Static Analysis PR

on:
  push:
    branches-ignore:
      - main

jobs:
  static_analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Clean workspace
        run: |
          rm -rf *

      # - name: Checkout Modified Paths
      #   uses: actions/checkout@v4
      #   with:
      #     sparse-checkout: |
      #       .github

      - run: |
          ls -la
          pwd

      - name: 'PR commits + 1'
        run: echo "PR_FETCH_DEPTH=$(( ${{ github.event.pull_request.commits }} + 1 ))" >> "${GITHUB_ENV}"

      - name: 'Checkout PR branch and all PR commits'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: ${{ env.PR_FETCH_DEPTH }}

      - name: Get Modified Paths
        id: get-paths
        run: |
          # Ottieni il nome del branch corrente
          current_branch=${GITHUB_HEAD_REF}

          # Ottieni il commit di testa del branch corrente
          head_commit=$(git rev-parse HEAD)

          # Ottieni il commit di origine del branch corrente, se disponibile
          base_commit=$(git rev-parse --first-parent "$current_branch^1" 2>/dev/null || echo "$head_commit")

          # Imposta il riferimento per il diff
          if [ "$base_commit" = "$head_commit" ]; then
              diff_ref="HEAD"
          else
              diff_ref="$base_commit"
          fi

          # Ottieni i percorsi modificati rispetto al riferimento
          modified_paths_source=$(git diff --name-only $diff_ref | grep -v 'domains' | grep '/' | cut -d '/' -f 1,2 | uniq)
          echo "$modified_paths_source"

          modified_paths_domains=$(git diff --name-only $diff_ref | grep 'domains' | grep '/' | cut -d '/' -f 1,2,3 | uniq)
          echo "$modified_paths_domains"

          # Unisci i percorsi modificati e aggiungi il percorso ".github"
          modified_paths="$modified_paths_source $modified_paths_domains .github"
          variabile_multiline=$(echo "$modified_paths" | tr ' ' '\\n')

          echo "ðŸ“Œ modified_paths"
          echo "$modified_paths" > "/tmp/paths.txt"
        shell: bash

      - name: ðŸ‘€ See folders downloaded
        id: download
        shell: bash
        run: |
          cat /tmp/paths.txt
          PAGOPA_MULTIPLE_FOLDERS=$(fold -w $(wc -L < "/tmp/paths.txt") < "/tmp/paths.txt")
          echo $PAGOPA_MULTIPLE_FOLDERS
          git sparse-checkout init --cone
          git sparse-checkout set $PAGOPA_MULTIPLE_FOLDERS
          git checkout

#      - name: Checkout Modified Paths
#        uses: actions/checkout@v4
#        with:
#          sparse-checkout: |
#            $(fold -w $(wc -L < "/tmp/paths.txt") < "/tmp/paths.txt")

      - name: See folders downloaded
        id: see
        shell: bash
        run: |
          ls -la
          du -h -d 3 .

      # - name: Static Analysis
      #   uses: pagopa/eng-github-actions-iac-template/azure/terraform-static-analysis@v1.14.1
      #   with:
      #     precommit_version: 'v1.89.1@sha256:1ea921bc4fe87651d41677218e537afdcdb8202e757e554b9866668eaba144c5'


